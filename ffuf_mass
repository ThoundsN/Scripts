#!/usr/bin/env bash
ffuf_Wordlist=/root/Wordlist/endpoint/10w_common.txt
iprange="173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/12 172.64.0.0/13 131.0.72.0/22"


usage() { echo -e "Usage: $0 -f input file, -o outputdir " 1>&2; exit 1; }

while getopts ":f:o:" o; do
    case "${o}" in
      f) input=$OPTARG
        ;;
      o) outputdir=$OPTARG
          ;;
      *) usage
        exit 1
          ;;
    esac
done
shift $((OPTIND - 1))

export outputdir
export ffuf_Wordlist
export iprange

[ ! -d "$outputdir" ] && echo "Directory "$outputdir" DOES NOT exists." && exit 1

outputdir=$(realpath ${outputdir})

mkdir -p $outputdir/raw/
mkdir -p $outputdir/processed/
touch $outputdir/ffuf_output.html


ffuf_one(){
    _domain=$(echo $1 | unfurl -unique domain )
    ip=$(dig +short ${_domain}  @8.8.8.8 | tail -n 1)
    if [[ ! $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
       echo "Dns look up for $1 has some problem " >> $outputdir/ffuf_output.html
       return
    fi
    echo "$ip" | grepcidr "$iprange" > /dev/null && echo "<h3>$1 ----   $ip is in cloudfare</h3>" >> $outputdir/ffuf_output.html && return
    echo "ffufing $1 "
    ffuf -w $ffuf_Wordlist   -u $1/FUZZ -se -r -sf -fs 0 -fw 1  -o $outputdir/raw/${_domain} -of csv
    python3 /root/recon_tools/Scripts/python/ffuf_process.py $outputdir/raw/${_domain}  $outputdir/processed/"${_domain}_processed"
}


export -f ffuf_one


cat $input | parallel -j2 ffuf_one {}


python3 ~/recon_tools/Scripts/python/ffuf_html.py  $outputdir/processed/  $outputdir/ffuf_output.html
